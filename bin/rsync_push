#!/bin/bash
# Use cases (rp for rsync_push)
# rp ./file host /dir/to/folder  =>  ./file -> /dir/to/folder/file
# rp ./folder host /dir/parent  =>  ./folder/ -> /dir/parent/folder
# rp ./folder/ host /dir/to/other/name  =>  ./folder/ -> /dir/to/other/name
# rp ./file host  =>  ./file -> /dir/to/file
# rp ./folder host  =>  ./folder/ -> /dir/to/folder
# rp ./folder/ host  =>  ./folder/ -> /dir/to/folder
# rp /dir/to/folder/ host  =>  /dir/to/folder/ -> /absolute/dir/to/folder


CMD="rsync -avhH --partial-dir=.rsync-partial --exclude __pycache__/ --delete"

COLOR_RESET="\033[0m"
BOLD_TEXT="\033[1m"
UNDERLINE_TEXT="\033[4m"

if [[ "$#" -lt 2 || "$#" -gt 3 ]]; then
    echo "rsync_push: push project folder to host"
    echo "Usage: $0 <local_folder> <hostname> [remote_path]"
    exit 1
fi
local_folder=$1
host=$2
remote_path=$(realpath $local_folder)  # realpath to allow relative path, only abs path works on remote

if [[ "$#" -eq 3 ]]; then
    remote_path=$3  # overwrite
fi

# Prompt for confirmation
echo -en "Sync: $BOLD_TEXT$UNDERLINE_TEXT$local_folder/$COLOR_RESET -> $host:$BOLD_TEXT$UNDERLINE_TEXT$remote_path$COLOR_RESET? [Y/n] " 
read -r

# Execute rsync if the user confirms or doesn't enter anything
if [[ $REPLY =~ ^[Yy]$ ]] || [[ -z $REPLY ]]; then
    # trailing slash matters: https://unix.stackexchange.com/a/605502
    $CMD $local_folder/ $host:$remote_path
fi
